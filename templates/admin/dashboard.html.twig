<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Ecoride</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/styles.css') }}">
    <link rel="stylesheet" href="{{ asset('css/dashboard.css') }}"> <!-- Ajoutez le CSS spécifique au tableau de bord -->
</head>
<body>
    <header>
        <div>
            <img src="{{ asset('images/logo.png') }}" alt="EcoRide" class="logo">
            <h1>EcoRide</h1>
        </div>
        <!-- Bouton de menu pour les appareils mobiles -->
        <div class="menu-toggle">&#9776;</div>
        <!-- Navigation -->
        <nav>
            <a class="active" href="{{ path('app_default_home') }}">Accueil</a>
            <a href="{{ path('trajets') }}">Trajets</a>
            <a href="{{ path('app_default_services') }}">Services</a>
            <a href="{{ path('app_default_contact') }}">Contact</a>
            <a href="{{ path('feedback') }}">Témoignages</a>
            <a href="{{ path('app_login') }}">Connexion</a>
        </nav>
    </header>
    <!-- Contenu principal -->
    <div class="container">
        <!-- Big Title -->
        <div class="big-title">
            <img src="{{ asset('images/covoit-1.jpg') }}" alt="Dashboard" class="full-width-image">
            <div class="big-title-overlay"></div>
            <h2>Dashboard</h2>
        </div>
        <!-- Dashboard tabs -->
        <div class="dashboard-tabs">
            <ul class="nav nav-tabs">
                <li class="nav-item"><a class="nav-link active" data-toggle="tab" href="#trajets">Trajets</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#utilisateurs">Utilisateurs</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#services">Services</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#temoignages">Témoignages</a></li>
                <li class="nav-item"><a class="nav-link" data-toggle="tab" href="#general">Général</a></li>
            </ul>
            <!-- Contenu des onglets -->
            <div class="tab-content">
                <div id="trajets" class="tab-pane fade">
                    <h3>Gestion des trajets</h3>
                    <hr>
                    <!-- Tableau pour afficher les trajets -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Conducteur</th>
                                <th>Prix</th>
                                <th>Depart</th>
                                <th>Destination</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="trajets-table">

                        </tbody>
                    </table>


                    <h4>Créer un nouveau trajet</h4>
                    <form id="create-trajet-form" action="{{ path('api_trajets_trajets_new') }}" method="post" enctype="multipart/form-data">
                        <div class="form-group">
                            <label for="driver">Conducteur</label>
                            <input type="text" name="driver" id="driver" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="price">Prix</label>
                            <input type="number" name="price" id="price" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="depart">Depart</label>
                            <input type="text" name="depart" id="depart" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="destination">Destination</label>
                            <input type="text" name="destination" id="destination" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="image">Image</label>
                            <input type="file" name="image" id="image" class="form-control-file" accept="image/**">
                        </div>
                        <button type="submit" class="btn btn-primary">Créer le trajet</button>
                    </form>

                    <!-- Script JavaScript pour gérer les interactions avec l'API -->
                    <script>
                        // Fonction pour afficher les trajets
                        function fetchTrajets() {
                            fetch('{{ path('api_trajets_trajets_index') }}')
                                .then(response => response.json())
                                .then(data => {
                                    const trajetsTable = document.getElementById('trajets-table');
                                    trajetsTable.innerHTML = '';
                                    data.forEach(trajet => {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>${trajet.id}</td>
                                            <td>${trajet.driver}</td>
                                            <td>${trajet.price}</td>
                                            <td>${trajet.depart}</td>
                                            <td>${trajet.destination}</td>
                                            <td>${trajet.img}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="editTrajets(${trajet.id})">Modifier</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteTrajets(${trajet.id})">Supprimer</button>
                                            </td>
                                        `;
                                        trajetsTable.appendChild(row);
                                    });
                                });
                        }

                        document.getElementById('create-trajets-form').addEventListener('submit', function(event) {
                            event.preventDefault();
                            const formData = new FormData(this);
                            const trajetsData = {};
                            formData.forEach((value, key) => {
                                trajetsData[key] = value;
                            });
                            fetch('{{ path('api_trajets_trajets_new') }}', {
                                method: 'POST',
                                body: JSON.stringify(trajetData),
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(() => {
                                fetchtrajets();
                                this.reset();
                            });
                        });

                        function editTrajet(id) {
                            const newDriver = prompt('Entrez le nom du conducteur :');
                            if (newDriver) {
                                fetch('{{ path('api_trajets_trajets_edit', {'id': 0}) }}'.replace('0', id), {
                                    method: 'PUT',
                                    body: JSON.stringify({ driver: newDriver }),
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(() => fetchTrajets());
                            }
                        }

                        function deleteTrajet(id) {
                            if (confirm('Êtes-vous sûr de vouloir supprimer ce trajet ?')) {
                                fetch('{{ path('api_trajets_trajets_delete', {'id': 0}) }}'.replace('0', id), {
                                    method: 'DELETE'
                                })
                                .then(() => fetchTrajets());
                            }
                        }

                        fetchTrajets();
                    </script>
                </div>
                <div id="utilisateurs" class="tab-pane fade">
                    <!-- Contenu pour l'onglet Utilisateurs -->
                    <h3>Gestion des utilisateurs</h3>
                    <hr>
                    <!-- Tableau pour afficher les utilisateurs -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nom d'utilisateur</th>
                                <th>Prénom</th>
                                <th>Nom de famille</th>
                                <th>Email</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table">
                            <!-- Les utilisateurs seront affichés ici -->
                        </tbody>
                    </table>

                    <!-- Formulaire pour créer un nouvel utilisateur -->
                    <h4>Créer un nouvel utilisateur</h4>
                    <form id="create-user-form">
                        <div class="form-group">
                            <label for="username">Nom d'utilisateur</label>
                            <input type="text" name="username" id="username" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Adresse email</label>
                            <input type="email" name="email" id="email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="firstname">Prénom</label>
                            <input type="text" name="firstname" id="firstname" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="lastname">Nom de famille</label>
                            <input type="text" name="lastname" id="lastname" class="form-control" required>
                        </div>
                        <input type="hidden" name="role" value="user">
                        <div class="form-group">
                            <label for="password">Mot de passe</label>
                            <input type="password" name="password" id="password" class="form-control" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Créer l'utilisateur</button>
                    </form>

                    <!-- Script JavaScript pour gérer les interactions avec l'API -->
                    <script>
                        // Fonction pour afficher les utilisateurs
                        function fetchUsers() {
                            fetch('{{ path('api_users_index') }}')
                                .then(response => response.json())
                                .then(data => {
                                    const usersTable = document.getElementById('users-table');
                                    usersTable.innerHTML = '';
                                    data.forEach(user => {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>${user.id}</td>
                                            <td>${user.username}</td>
                                            <td>${user.firstname}</td>
                                            <td>${user.lastname}</td>
                                            <td>${user.email}</td>
                                            <td>
                                                <button class="btn btn-primary btn-sm" onclick="editUser(${user.id})">Modifier</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id})">Supprimer</button>
                                            </td>
                                        `;
                                        usersTable.appendChild(row);
                                    });
                                });
                        }

                        // Fonction pour créer un nouvel utilisateur
                            document.getElementById('create-user-form').addEventListener('submit', function(event) {
                                event.preventDefault();
                                const formData = new FormData(this);
                                const userData = {};
                                formData.forEach((value, key) => {
                                    userData[key] = value;
                                });
                                userData['roles[]'] = ['ROLE_USER']; // Ajout du rôle ROLE_USER lors de la création de l'utilisateur
                                fetch('{{ path('api_users_new') }}', {
                                    method: 'POST',
                                    body: JSON.stringify(userData),
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(() => {
                                    fetchUsers();
                                    this.reset();
                                });
                            });

                        // Fonction pour modifier un utilisateur
                        function editUser(id) {
                            const newUsername = prompt('Entrez le nouveau nom d\'utilisateur :');
                            if (newUsername) {
                                fetch('{{ path('api_users_edit', {'id': 0}) }}'.replace('0', id), {
                                    method: 'PUT',
                                    body: JSON.stringify({ username: newUsername }),
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                })
                                .then(() => fetchUsers());
                            }
                        }

                        // Fonction pour supprimer un utilisateur
                        function deleteUser(id) {
                            if (confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?')) {
                                fetch('{{ path('api_users_delete', {'id': 0}) }}'.replace('0', id), {
                                    method: 'DELETE'
                                })
                                .then(() => fetchUsers());
                            }
                        }

                        // Appel initial pour afficher les utilisateurs
                        fetchUsers();
                    </script>
                </div>
                <div id="services" class="tab-pane fade">
                    <!-- Contenu pour l'onglet Services -->
                    <h3>Contenu de l'onglet Services</h3>
                    <p>fonctionnalité à venir</p>
                </div>
                <div id="temoignages" class="tab-pane fade">
                    <!-- Contenu pour l'onglet Témoignages -->
                    <h3>Gestion des Témoignages</h3>
                    <hr>
                    <!-- Tableau pour afficher les témoignages -->
                    <table class="table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Auteur</th>
                                <th>Note</th>
                                <th>Message</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="feedbacks-table">
                            <!-- Les témoignages seront affichés ici -->
                        </tbody>
                    </table>

                    <!-- Script JavaScript pour gérer les interactions avec l'API -->
                    <script>
                        // Fonction pour afficher les témoignages
                        function fetchFeedbacks() {
                            fetch('{{ path('api_feedbacks_index') }}')
                                .then(response => response.json())
                                .then(data => {
                                    const feedbacksTable = document.getElementById('feedbacks-table');
                                    feedbacksTable.innerHTML = '';
                                    data.forEach(feedback => {
                                        const row = document.createElement('tr');
                                        row.innerHTML = `
                                            <td>${feedback.id}</td>
                                            <td>${feedback.authorName}</td>
                                            <td>${feedback.rating}</td>
                                            <td>${feedback.message}</td>
                                            <td>${feedback.moderationStatus}</td>
                                            <td>
                                                <button class="btn btn-success btn-sm" onclick="approveFeedback(${feedback.id})">Approuver</button>
                                                <button class="btn btn-danger btn-sm" onclick="deleteFeedback(${feedback.id})">Supprimer</button>
                                            </td>
                                        `;
                                        feedbacksTable.appendChild(row);
                                    });
                                });
                        }

                        // Fonction pour approuver un témoignage
                        function approveFeedback(id) {
                            fetch('{{ path('api_feedbacks_approve', {'id': 0}) }}'.replace('0', id), {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json'
                                }
                            })
                            .then(() => fetchFeedbacks());
                        }

                        // Fonction pour supprimer un témoignage
                        function deleteFeedback(id) {
                            if (confirm('Êtes-vous sûr de vouloir supprimer ce témoignage ?')) {
                                fetch('{{ path('api_feedbacks_delete', {'id': 0}) }}'.replace('0', id), {
                                    method: 'DELETE'
                                })
                                .then(() => fetchFeedbacks());
                            }
                        }

                        // Appel initial pour afficher les témoignages
                        fetchFeedbacks();
                    </script>
                </div>

                <div id="general" class="tab-pane fade">
                    <!-- Contenu pour l'onglet Général -->
                    <h3>Modifier les horaires d'ouverture</h3>
                    <p>fonctionnalité à venir</p>
                    <form method="post">
                        <div class="mb-3">
                            <label for="opening_hours" class="form-label">Horaires d'ouverture</label>
                            <input type="text" class="form-control" id="opening_hours" name="opening_hours" placeholder="Entrez les horaires d'ouverture" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Bouton fixe pour laisser un avis -->
    <div class="info-bubble">Laissez un avis !</div>
    <a href="{{ path('feedback') }}" class="fixed-button">
        <i class="fas fa-comment"></i>
    </a>
    <!-- Pied de page -->
    <footer>
        <div class="container-footer">
            <div class="footer-section">
                Agissez face à la pollution !
            </div>
            <div class="footer-section">
                <h4>Ensemble, vers une mobilité plus verte.</h4>
            </div>
            <div class="footer-section">
                <a href="{{ path('app_default_contact') }}">Nous contacter</a>
            </div>
        </div>
        <div class="copyright">
            <!-- Droits d'auteur -->
            <p>Tous droits réservés &copy; 2025 Ecoride</p>
        </div>
    </footer>
    <!-- Chargement de la bibliothèque jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Chargement de la bibliothèque Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Script pour activer/désactiver la navigation sur les appareils mobiles -->
    <script src="{{ asset('js/menu.js') }}"></script>
    <script src="{{ asset('js/dashboard.js') }}"></script>
    <!-- Chargement de la bibliothèque d'icônes -->
    <script src="https://kit.fontawesome.com/8bd5dfedd7.js" crossorigin="anonymous"></script>
</body>
</html>
